<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>北商rule是說 Chatbot</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
      overflow: hidden;
    }

    body {
      display: flex;
      flex-direction: column;
    }

    header {
      background-color: #f1f1f1;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .main-container {
      display: flex;
      flex: 1;
      height: calc(100vh - 60px);
    }

    #sidebar {
      width: 280px;
      background-color: #fafafa;
      border-right: 1px solid #ccc;
      padding: 10px;
      overflow-y: auto;
    }

    #chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
      overflow-y: auto;
    }

    .message {
      max-width: 70%;
      margin: 10px 0;
      padding: 10px 14px;
      border-radius: 8px;
      background-color: #e0e0e0;
      display: flex;
      align-items: flex-end;
    }

    .user {
      align-self: flex-end;
      justify-content: flex-end;
    }

    .bot {
      align-self: flex-start;
    }

    .avatar {
      margin: 0 8px;
    }

    .input-area {
      position: absolute;
      bottom: 0;
      left: 280px;
      right: 0;
      background-color: #f9f9f9;
      padding: 12px;
      display: flex;
      justify-content: center;
      align-items: center;
      border-top: 1px solid #ccc;
    }

    .input-area input {
      width: 33%;
      padding: 10px;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-right: 10px;
    }

    .input-area button {
      padding: 10px 16px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .conversation-title {
      background: #eee;
      margin-bottom: 5px;
      padding: 8px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .conversation-title input {
      width: 100px;
      border: none;
      background: transparent;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <header>
    <div>北商rule是說 Chatbot</div>
  </header>

  <div class="main-container">
    <div id="sidebar">
      <button onclick="startNewConversation()">➕ 開啟新對話</button>
      <h2>對話紀錄</h2>
      <div id="conversation-list"></div>
    </div>

    <div id="chat-area">
      <div id="chat-messages"></div>
    </div>
  </div>

  <div class="input-area">
    <input id="input" type="text" placeholder="輸入問題..." onkeydown="handleKeyDown(event)" />
    <button onclick="send()">送出</button>
  </div>

  <script>
    let allConversations = [{ title: "新對話1", messages: [] }];
    let currentConversation = allConversations[0];

    function renderConversationList() {
      const list = document.getElementById("conversation-list");
      list.innerHTML = "";
      allConversations.forEach((conv, idx) => {
        const div = document.createElement("div");
        div.className = "conversation-title";
        div.innerHTML = `
          <input value="${conv.title}" onchange="renameTitle(${idx}, this.value)" />
          <div>
            <button onclick="loadConversation(${idx})">📂</button>
            <button onclick="exportConversation(${idx})">💾</button>
            <button onclick="deleteConversation(${idx})">❌</button>
          </div>`;
        list.appendChild(div);
      });
    }

    function renameTitle(index, newTitle) {
      allConversations[index].title = newTitle;
      renderConversationList();
    }

    function deleteConversation(index) {
      allConversations.splice(index, 1);
      renderConversationList();
    }

    function exportConversation(index) {
      const conv = allConversations[index];
      const text = conv.messages.map(m => (m.role === "user" ? "😀 " : "🦉 ") + m.text).join("\n");
      const blob = new Blob([text], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = conv.title + ".txt";
      a.click();
      URL.revokeObjectURL(url);
    }

    function loadConversation(index) {
      currentConversation = allConversations[index];
      renderMessages();
    }

    function startNewConversation() {
      const newTitle = `新對話${allConversations.length + 1}`;
      currentConversation = { title: newTitle, messages: [] };
      allConversations.unshift(currentConversation);  // Add to the top of the list
      renderConversationList();
      renderMessages();
    }

    function renderMessages() {
      const area = document.getElementById("chat-messages");
      area.innerHTML = "";
      currentConversation.messages.forEach(m => {
        const div = document.createElement("div");
        div.className = "message " + (m.role === "user" ? "user" : "bot");
        div.innerHTML = `
          ${m.role === "bot" ? '<div class="avatar">🦉</div>' : ""}
          <div style="max-width: fit-content; display: inline-block;">${m.text}</div>
          ${m.role === "user" ? '<div class="avatar">😀</div>' : ""}`;
        area.appendChild(div);
      });
      area.scrollTop = area.scrollHeight;
    }

    async function send() {
      const input = document.getElementById("input");
      const question = input.value.trim();
      if (!question) return;

      currentConversation.messages.push({ role: "user", text: question });
      renderMessages();
      input.value = "";

      const res = await fetch("/ask/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ question })
      });

      const data = await res.json();
      const reply = data.answer || "（無回應）";
      currentConversation.messages.push({ role: "bot", text: reply });
      renderMessages();
    }

    function handleKeyDown(event) {
      if (event.key === "Enter") {
        send();
      }
    }

    renderConversationList();
    renderMessages();
  </script>
</body>
</html>
